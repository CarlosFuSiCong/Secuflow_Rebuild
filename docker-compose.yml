version: "3.9"

services:
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile.api
    environment:
      - DJANGO_SETTINGS_MODULE=secuflow.settings
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:8000/api
      - AWS_REGION=us-east-1
      - TNM_SQS_QUEUE_URL=http://localstack:4566/000000000000/tnm-jobs
      - TNM_S3_BUCKET=tnm-results
    ports:
      - "8000:8000"
    depends_on:
      - localstack

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.worker
    environment:
      - DJANGO_SETTINGS_MODULE=secuflow.settings
      - AWS_REGION=us-east-1
      - TNM_SQS_QUEUE_URL=http://localstack:4566/000000000000/tnm-jobs
      - TNM_S3_BUCKET=tnm-results
      - TNM_JAVA_PATH=java
      - TNM_JAR_PATH=/tnm/cli/build/libs/cli-all.jar
      - TNM_TIMEOUT=1200
    volumes:
      - ./tnm:/tnm:ro
    depends_on:
      - localstack

  localstack:
    image: localstack/localstack:latest
    environment:
      - SERVICES=s3,sqs
      - DEFAULT_REGION=us-east-1
    ports:
      - "4566:4566"
    volumes:
      - localstack-data:/var/lib/localstack

  aws-setup:
    image: amazon/aws-cli:2.15.0
    depends_on:
      - localstack
    entrypoint: /bin/sh -c
    command: >
      "aws --endpoint-url=http://localstack:4566 sqs create-queue --queue-name tnm-jobs &&
       aws --endpoint-url=http://localstack:4566 s3 mb s3://tnm-results || true"

volumes:
  localstack-data:


